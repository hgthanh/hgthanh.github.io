name: Generate package-lock.json

on:
  workflow_dispatch: # Manual trigger
  push:
    paths:
      - 'package.json'
    branches: [ main ]

jobs:
  generate-lockfile:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || !contains(github.event.head_commit.message, 'package-lock.json')
    
    steps:
    - name: Checkout ğŸ›ï¸
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js âš™ï¸
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Check if package-lock.json exists ğŸ”
      id: check-lockfile
      run: |
        if [ -f package-lock.json ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "âœ… package-lock.json already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "âŒ package-lock.json does not exist"
        fi

    - name: Generate package-lock.json ğŸ“¦
      if: steps.check-lockfile.outputs.exists == 'false'
      run: |
        echo "ğŸ”„ Generating package-lock.json..."
        npm install --package-lock-only
        echo "âœ… package-lock.json generated successfully"

    - name: Verify package-lock.json ğŸ§ª
      if: steps.check-lockfile.outputs.exists == 'false'
      run: |
        echo "ğŸ” Verifying package-lock.json..."
        if [ -f package-lock.json ]; then
          echo "âœ… package-lock.json created successfully"
          echo "ğŸ“Š File size: $(wc -c < package-lock.json) bytes"
          echo "ğŸ“‹ Dependencies count: $(jq '.dependencies | length' package-lock.json)"
        else
          echo "âŒ Failed to create package-lock.json"
          exit 1
        fi

    - name: Commit and push package-lock.json ğŸ’¾
      if: steps.check-lockfile.outputs.exists == 'false'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add package-lock.json
        git commit -m "chore: add package-lock.json

        - Auto-generated by GitHub Actions
        - Ensures consistent dependency versions
        - Required for npm ci in deployment"
        git push